<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Vidalytics Analytics</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: #0a0a0a; color: #e5e5e5; line-height: 1.5;
}
.container { max-width: 1100px; margin: 0 auto; padding: 24px; }
h1 { color: #fff; font-size: 24px; margin-bottom: 4px; }
.subtitle { color: #888; font-size: 14px; margin-bottom: 24px; }
.usage-bar { display: flex; align-items: center; gap: 8px; font-size: 12px; color: #888; }
.usage-bar .bar { flex: 1; max-width: 120px; height: 6px; background: #262626; border-radius: 3px; overflow: hidden; }
.usage-bar .bar-fill { height: 100%; background: #3b82f6; border-radius: 3px; transition: width 0.3s; }

/* Controls */
.controls {
  display: flex; gap: 12px; align-items: center; margin-bottom: 24px; flex-wrap: wrap;
}
.controls input[type="date"] {
  background: #141414; border: 1px solid #333; border-radius: 8px;
  color: #e5e5e5; padding: 8px 12px; font-size: 14px;
}
.controls button {
  background: #3b82f6; color: #fff; border: none; border-radius: 8px;
  padding: 8px 20px; font-size: 14px; font-weight: 600; cursor: pointer;
}
.controls button:hover { background: #2563eb; }
.controls button:disabled { opacity: 0.5; cursor: not-allowed; }

/* Cards */
.cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; }
.card {
  background: #141414; border: 1px solid #262626; border-radius: 12px; padding: 20px;
}
.card-label { color: #888; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; }
.card-value { color: #fff; font-size: 28px; font-weight: 700; margin-top: 4px; }
.card-sub { color: #888; font-size: 12px; margin-top: 2px; }

/* Alerts */
.alerts { margin-bottom: 24px; }
.alert {
  padding: 14px 18px; border-radius: 8px; margin-bottom: 10px;
  border-left: 4px solid; font-size: 14px;
}
.alert-critical { background: #2d1515; border-color: #f87171; color: #fca5a5; }
.alert-warning { background: #2d2515; border-color: #fb923c; color: #fdba74; }
.alert-positive { background: #152d15; border-color: #4ade80; color: #86efac; }
.alert-title { font-weight: 600; margin-bottom: 2px; }
.alert-action { color: #e5e5e5; margin-top: 4px; font-size: 13px; }

/* Table */
.table-wrap {
  background: #141414; border: 1px solid #262626; border-radius: 12px;
  overflow-x: auto; margin-bottom: 24px;
}
table { width: 100%; border-collapse: collapse; }
th {
  text-align: left; padding: 12px 16px; color: #888; font-size: 12px;
  text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid #262626;
  cursor: pointer; user-select: none; white-space: nowrap;
}
th:hover { color: #e5e5e5; }
th .sort-arrow { margin-left: 4px; }
td { padding: 12px 16px; border-bottom: 1px solid #1a1a1a; font-size: 14px; }
tr:last-child td { border-bottom: none; }
tr.clickable { cursor: pointer; }
tr.clickable:hover { background: #1a1a1a; }
tr.selected { background: #1a2332; }
.video-name { color: #fff; font-weight: 500; max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

/* Score badge */
.badge { display: inline-block; padding: 3px 10px; border-radius: 6px; font-size: 12px; font-weight: 600; }
.badge-excellent { background: rgba(34,197,94,0.15); color: #4ade80; }
.badge-good { background: rgba(59,130,246,0.15); color: #60a5fa; }
.badge-average { background: rgba(250,204,21,0.15); color: #facc15; }
.badge-poor { background: rgba(251,146,60,0.15); color: #fb923c; }
.badge-critical { background: rgba(248,113,113,0.15); color: #f87171; }

/* Detail view (full-screen overlay) */
#detail-view {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: #0a0a0a; z-index: 1000; overflow-y: auto; display: none;
}
#detail-view.visible { display: block; }
.detail-inner { max-width: 1100px; margin: 0 auto; padding: 24px; }
.detail-topbar {
  display: flex; align-items: center; gap: 16px; margin-bottom: 24px;
  padding-bottom: 16px; border-bottom: 1px solid #262626;
}
.back-btn {
  background: #1a1a1a; border: 1px solid #333; border-radius: 8px;
  color: #e5e5e5; padding: 8px 16px; font-size: 14px; cursor: pointer;
  display: inline-flex; align-items: center; gap: 6px;
}
.back-btn:hover { background: #262626; color: #fff; }
.detail-header { display: flex; align-items: center; gap: 16px; margin-bottom: 20px; flex-wrap: wrap; }
.detail-title { color: #fff; font-size: 20px; font-weight: 600; }
.detail-score { font-size: 32px; font-weight: 700; }

/* Metrics grid */
.metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 24px; }
.metric-card { background: #1a1a1a; border-radius: 8px; padding: 14px; }
.metric-label { color: #888; font-size: 11px; text-transform: uppercase; }
.metric-value { font-size: 22px; font-weight: 700; color: #fff; }
.metric-rating { font-size: 11px; margin-top: 2px; }

/* Engagement chart */
.chart-section h3 { color: #fff; font-size: 16px; margin-bottom: 12px; }
.chart-container {
  position: relative; height: 200px; background: #1a1a1a;
  border: 1px solid #262626; border-radius: 8px; overflow: hidden;
  margin-bottom: 8px;
}
.chart-bars { display: flex; align-items: flex-end; height: 100%; padding: 0 2px; }
.chart-bar {
  flex: 1; min-width: 1px; background: rgba(59,130,246,0.5);
  border-radius: 1px 1px 0 0; transition: background 0.15s; position: relative;
}
.chart-bar:hover { background: rgba(59,130,246,0.8); }
.chart-bar.drop-bar { background: rgba(248,113,113,0.6); }
.chart-bar.drop-bar:hover { background: rgba(248,113,113,0.9); }
.chart-labels { display: flex; justify-content: space-between; font-size: 11px; color: #666; }
.chart-tooltip {
  position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
  background: #333; color: #fff; padding: 4px 8px; border-radius: 4px;
  font-size: 11px; white-space: nowrap; pointer-events: none; display: none; z-index: 10;
}
.chart-bar:hover .chart-tooltip { display: block; }

/* Drop-offs list */
.drops-section { margin-bottom: 24px; }
.drops-section h3 { color: #fff; font-size: 16px; margin-bottom: 12px; }
.drop-item {
  display: flex; align-items: center; gap: 12px; padding: 10px 14px;
  background: #1a1a1a; border-radius: 8px; margin-bottom: 8px;
}
.drop-time { color: #f87171; font-weight: 700; font-size: 16px; min-width: 50px; }
.drop-detail { flex: 1; font-size: 13px; }
.drop-pct { color: #f87171; font-weight: 600; font-size: 14px; }

/* Recommendations */
.recs-section h3 { color: #fff; font-size: 16px; margin-bottom: 12px; }
.rec-card {
  padding: 16px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid;
}
.rec-critical { background: #2d1515; border-color: #f87171; }
.rec-warning { background: #2d2515; border-color: #fb923c; }
.rec-suggestion { background: #152d2d; border-color: #60a5fa; }
.rec-positive { background: #152d15; border-color: #4ade80; }
.rec-title { font-weight: 600; font-size: 14px; color: #fff; margin-bottom: 4px; }
.rec-detail { font-size: 13px; color: #ccc; margin-bottom: 6px; }
.rec-action { font-size: 13px; color: #3b82f6; }

/* AI Analysis Section */
.ai-section {
  margin-top: 24px; border-top: 1px solid #262626; padding-top: 24px;
}
.ai-btn {
  background: linear-gradient(135deg, #7c3aed, #3b82f6); color: #fff; border: none;
  border-radius: 8px; padding: 10px 24px; font-size: 14px; font-weight: 600;
  cursor: pointer; display: inline-flex; align-items: center; gap: 8px;
}
.ai-btn:hover { opacity: 0.9; }
.ai-btn:disabled { opacity: 0.5; cursor: not-allowed; }
.ai-cache-info { display: inline-block; margin-left: 12px; font-size: 12px; color: #888; }

/* Video Context */
.context-section {
  margin-bottom: 16px;
}
.context-label {
  color: #888; font-size: 12px; margin-bottom: 6px;
  display: flex; align-items: center; gap: 6px;
}
.context-label .optional-tag {
  background: rgba(59,130,246,0.1); color: #60a5fa; font-size: 10px;
  padding: 1px 6px; border-radius: 3px; text-transform: uppercase; font-weight: 600;
}
.context-textarea {
  width: 100%; min-height: 70px; max-height: 200px; resize: vertical;
  background: #141414; border: 1px solid #333; border-radius: 8px;
  color: #e5e5e5; padding: 10px 12px; font-size: 13px; font-family: inherit;
  line-height: 1.5;
}
.context-textarea::placeholder { color: #555; }
.context-textarea:focus { outline: none; border-color: #7c3aed; }

.ai-loading {
  padding: 30px 20px; color: #888;
}
.ai-loading .spinner { border-top-color: #7c3aed; }
.ai-progress-wrap {
  margin-top: 16px;
}
.ai-progress-bar {
  width: 100%; height: 8px; background: #262626; border-radius: 4px; overflow: hidden;
  margin-bottom: 12px;
}
.ai-progress-fill {
  height: 100%; background: linear-gradient(90deg, #7c3aed, #3b82f6);
  border-radius: 4px; transition: width 0.5s ease; width: 0%;
}
.ai-steps {
  display: flex; justify-content: space-between; gap: 4px; margin-bottom: 14px;
}
.ai-step {
  flex: 1; text-align: center; font-size: 11px; color: #555; padding: 6px 2px;
  border-radius: 4px; transition: all 0.3s;
}
.ai-step.active { color: #c4b5fd; background: rgba(124,58,237,0.1); }
.ai-step.done { color: #4ade80; }
.ai-step-icon { font-size: 16px; display: block; margin-bottom: 2px; }
.ai-progress-label {
  font-size: 14px; color: #e5e5e5; font-weight: 500;
}
.ai-progress-detail {
  font-size: 13px; color: #888; margin-top: 4px;
}

/* Expert Tabs */
.expert-tabs {
  display: flex; gap: 4px; margin-bottom: 16px; flex-wrap: wrap;
}
.expert-tab {
  background: #1a1a1a; border: 1px solid #333; border-radius: 8px 8px 0 0;
  padding: 8px 16px; font-size: 13px; color: #888; cursor: pointer;
  border-bottom: 2px solid transparent; transition: all 0.2s;
}
.expert-tab:hover { color: #e5e5e5; background: #222; }
.expert-tab.active {
  color: #fff; background: #1a1a1a; border-color: #7c3aed;
  border-bottom-color: #7c3aed;
}
.expert-panel {
  background: #1a1a1a; border: 1px solid #333; border-radius: 0 8px 8px 8px;
  padding: 20px; display: none;
}
.expert-panel.active { display: block; }

.expert-header { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; }
.expert-name { color: #fff; font-size: 18px; font-weight: 600; }
.expert-role { color: #7c3aed; font-size: 13px; }
.expert-assessment { color: #ccc; font-size: 14px; margin-bottom: 16px; line-height: 1.6; }

.expert-strengths, .expert-weaknesses {
  margin-bottom: 16px;
}
.expert-strengths h4 { color: #4ade80; font-size: 13px; margin-bottom: 6px; }
.expert-weaknesses h4 { color: #f87171; font-size: 13px; margin-bottom: 6px; }
.expert-list { list-style: none; padding: 0; }
.expert-list li {
  padding: 6px 0 6px 20px; position: relative; font-size: 13px; color: #ccc;
}
.expert-list li::before {
  content: ''; position: absolute; left: 0; top: 12px;
  width: 8px; height: 8px; border-radius: 50%;
}
.expert-strengths .expert-list li::before { background: #4ade80; }
.expert-weaknesses .expert-list li::before { background: #f87171; }

.expert-fixes { margin-bottom: 16px; }
.expert-fixes h4 { color: #60a5fa; font-size: 13px; margin-bottom: 8px; }
.fix-item {
  background: #141414; border-radius: 6px; padding: 12px; margin-bottom: 8px;
  border-left: 3px solid #60a5fa;
}
.fix-timestamp { color: #7c3aed; font-weight: 600; font-size: 12px; }
.fix-issue { color: #fca5a5; font-size: 13px; margin-top: 4px; }
.fix-solution { color: #86efac; font-size: 13px; margin-top: 4px; }

.expert-priority {
  background: linear-gradient(135deg, rgba(124,58,237,0.1), rgba(59,130,246,0.1));
  border: 1px solid #7c3aed; border-radius: 8px; padding: 14px;
}
.expert-priority h4 { color: #7c3aed; font-size: 13px; margin-bottom: 4px; }
.expert-priority p { color: #e5e5e5; font-size: 14px; }

/* CRO Tests */
.cro-section { margin-top: 24px; }
.cro-section h3 { color: #fff; font-size: 16px; margin-bottom: 12px; }
.cro-card {
  background: #1a1a1a; border: 1px solid #333; border-radius: 8px;
  padding: 16px; margin-bottom: 12px;
}
.cro-name { color: #fff; font-weight: 600; font-size: 14px; margin-bottom: 6px; }
.cro-row { display: grid; grid-template-columns: 100px 1fr; gap: 4px; font-size: 13px; margin-bottom: 4px; }
.cro-label { color: #7c3aed; font-weight: 500; }
.cro-value { color: #ccc; }

/* Timestamp Analysis */
.timestamp-section { margin-top: 24px; }
.timestamp-section h3 { color: #fff; font-size: 16px; margin-bottom: 12px; }
.ts-card {
  background: #1a1a1a; border: 1px solid #333; border-radius: 8px;
  padding: 16px; margin-bottom: 10px; border-left: 4px solid #f87171;
}
.ts-time { color: #f87171; font-weight: 700; font-size: 16px; margin-bottom: 8px; }
.ts-row { font-size: 13px; margin-bottom: 4px; }
.ts-label { color: #888; font-weight: 500; }
.ts-content { color: #ccc; }
.ts-issue { color: #fca5a5; }
.ts-fix { color: #86efac; }

/* Script Structure */
.script-section { margin-top: 24px; }
.script-section h3 { color: #fff; font-size: 16px; margin-bottom: 12px; }
.script-grid {
  display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 12px; margin-bottom: 16px;
}
.script-card {
  background: #1a1a1a; border: 1px solid #333; border-radius: 8px; padding: 14px;
}
.script-label {
  color: #7c3aed; font-size: 11px; text-transform: uppercase;
  letter-spacing: 0.5px; margin-bottom: 6px; font-weight: 600;
}
.script-text { color: #ccc; font-size: 13px; line-height: 1.5; }
.script-flow {
  background: #1a1a1a; border: 1px solid #333; border-radius: 8px; padding: 14px;
}

/* Verdict */
.verdict-box {
  background: linear-gradient(135deg, rgba(124,58,237,0.08), rgba(59,130,246,0.08));
  border: 1px solid #7c3aed; border-radius: 12px; padding: 20px;
  margin-top: 24px;
}
.verdict-title { color: #7c3aed; font-size: 14px; font-weight: 600; margin-bottom: 8px; }
.verdict-text { color: #e5e5e5; font-size: 15px; line-height: 1.6; }

/* Script Rewriter */
.rewrite-btn {
  background: linear-gradient(135deg, #f59e0b, #ef4444); color: #fff; border: none;
  border-radius: 8px; padding: 10px 20px; font-size: 13px; font-weight: 600;
  cursor: pointer; display: inline-flex; align-items: center; gap: 8px;
  margin-top: 16px;
}
.rewrite-btn:hover { opacity: 0.9; }
.rewrite-btn:disabled { opacity: 0.5; cursor: not-allowed; }
.rewrite-container { margin-top: 16px; }

.rewrite-summary {
  background: linear-gradient(135deg, rgba(245,158,11,0.08), rgba(239,68,68,0.08));
  border: 1px solid #f59e0b; border-radius: 12px; padding: 20px;
  margin-bottom: 20px;
}
.rewrite-summary-title { color: #f59e0b; font-size: 14px; font-weight: 600; margin-bottom: 8px; }
.rewrite-summary-text { color: #e5e5e5; font-size: 14px; line-height: 1.6; }

.rewrite-section {
  background: #141414; border: 1px solid #333; border-radius: 10px;
  margin-bottom: 16px; overflow: hidden;
}
.rewrite-section-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 12px 16px; background: #1a1a1a; border-bottom: 1px solid #333;
  cursor: pointer;
}
.rewrite-section-name {
  color: #f59e0b; font-weight: 600; font-size: 14px; text-transform: uppercase;
  letter-spacing: 0.5px;
}
.rewrite-section-toggle { color: #888; font-size: 12px; }
.rewrite-section-body { padding: 0; }
.rewrite-section-body.collapsed { display: none; }

.rewrite-columns {
  display: grid; grid-template-columns: 1fr 1fr; gap: 0;
}
@media (max-width: 768px) {
  .rewrite-columns { grid-template-columns: 1fr; }
}
.rewrite-col {
  padding: 16px; border-right: 1px solid #262626;
}
.rewrite-col:last-child { border-right: none; }
.rewrite-col-label {
  font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px;
  font-weight: 600; margin-bottom: 8px;
}
.rewrite-col-label.original { color: #888; }
.rewrite-col-label.rewritten { color: #4ade80; }
.rewrite-col-text {
  font-size: 13px; line-height: 1.7; color: #ccc; white-space: pre-wrap;
}
.rewrite-explanation {
  padding: 12px 16px; background: #0f0f0f; border-top: 1px solid #262626;
}
.rewrite-explanation-label { color: #7c3aed; font-size: 11px; font-weight: 600; margin-bottom: 4px; }
.rewrite-explanation-text { color: #aaa; font-size: 12px; line-height: 1.5; }
.rewrite-principle {
  margin-top: 4px; font-size: 11px; color: #f59e0b; font-style: italic;
}

.rewrite-full-toggle {
  background: #1a1a1a; border: 1px solid #333; border-radius: 8px;
  color: #e5e5e5; padding: 10px 20px; font-size: 13px; font-weight: 500;
  cursor: pointer; display: inline-flex; align-items: center; gap: 8px;
  margin-top: 12px;
}
.rewrite-full-toggle:hover { background: #262626; color: #fff; }
.rewrite-full-script {
  background: #141414; border: 1px solid #333; border-radius: 10px;
  padding: 20px; margin-top: 12px; display: none;
}
.rewrite-full-script.visible { display: block; }
.rewrite-full-script-text {
  font-size: 14px; line-height: 1.8; color: #e5e5e5; white-space: pre-wrap;
}
.rewrite-cache-info { display: inline-block; margin-left: 12px; font-size: 12px; color: #888; }

/* Generate CRO Tests */
.generate-cro-btn {
  background: linear-gradient(135deg, #10b981, #3b82f6); color: #fff; border: none;
  border-radius: 8px; padding: 10px 20px; font-size: 13px; font-weight: 600;
  cursor: pointer; display: inline-flex; align-items: center; gap: 8px;
  margin-top: 16px;
}
.generate-cro-btn:hover { opacity: 0.9; }
.generate-cro-btn:disabled { opacity: 0.5; cursor: not-allowed; }

.generated-batches { margin-top: 16px; }
.generated-batch {
  margin-bottom: 16px; border: 1px solid #333; border-radius: 10px; overflow: hidden;
}
.generated-batch-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 10px 16px; background: #141414; border-bottom: 1px solid #333;
  cursor: pointer;
}
.generated-batch-title {
  color: #10b981; font-weight: 600; font-size: 13px;
  display: flex; align-items: center; gap: 8px;
}
.generated-batch-toggle { color: #888; font-size: 12px; }
.generated-batch-body { padding: 0; }
.generated-batch-body.collapsed { display: none; }

.new-badge {
  display: inline-block; background: rgba(16,185,129,0.15); color: #10b981;
  padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 700;
  text-transform: uppercase; letter-spacing: 0.5px;
}

.cro-gen-steps {
  display: flex; justify-content: space-between; gap: 4px; margin-bottom: 14px;
}
.cro-gen-step {
  flex: 1; text-align: center; font-size: 11px; color: #555; padding: 6px 2px;
  border-radius: 4px; transition: all 0.3s;
}
.cro-gen-step.active { color: #6ee7b7; background: rgba(16,185,129,0.1); }
.cro-gen-step.done { color: #4ade80; }
.cro-gen-step-icon { font-size: 16px; display: block; margin-bottom: 2px; }

/* Rewrite progress bar (reuses AI progress pattern) */
.rewrite-progress-wrap { margin-top: 16px; }
.rewrite-steps {
  display: flex; justify-content: space-between; gap: 4px; margin-bottom: 14px;
}
.rewrite-step {
  flex: 1; text-align: center; font-size: 11px; color: #555; padding: 6px 2px;
  border-radius: 4px; transition: all 0.3s;
}
.rewrite-step.active { color: #fbbf24; background: rgba(245,158,11,0.1); }
.rewrite-step.done { color: #4ade80; }
.rewrite-step-icon { font-size: 16px; display: block; margin-bottom: 2px; }

/* Loading / Error */
.loading { text-align: center; padding: 60px 20px; color: #888; }
.spinner {
  display: inline-block; width: 24px; height: 24px; border: 3px solid #333;
  border-top-color: #3b82f6; border-radius: 50%;
  animation: spin 0.7s linear infinite; margin-bottom: 12px;
}
@keyframes spin { to { transform: rotate(360deg); } }
.error-msg {
  background: #2d1515; border: 1px solid #7f1d1d; border-radius: 8px;
  padding: 16px; color: #fca5a5; margin-bottom: 24px;
}
.hidden { display: none; }

/* Report Download Button */
.report-btn {
  background: linear-gradient(135deg, #3b82f6, #8b5cf6);
  color: #fff; border: none; border-radius: 8px;
  padding: 8px 20px; font-size: 13px; font-weight: 600;
  cursor: pointer; display: inline-flex; align-items: center; gap: 6px;
  margin-left: auto; white-space: nowrap;
}
.report-btn:hover { opacity: 0.9; }
.report-btn:disabled { opacity: 0.5; cursor: not-allowed; }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.2/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.4/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
<div class="container">
  <div style="display:flex;justify-content:space-between;align-items:start;flex-wrap:wrap;gap:12px;margin-bottom:20px;">
    <div>
      <h1>Vidalytics Analytics</h1>
      <div class="subtitle">Video performance analysis &amp; recommendations</div>
    </div>
    <div class="usage-bar" id="usage-bar">
      <span id="usage-text">API: --</span>
      <div class="bar"><div class="bar-fill" id="usage-fill" style="width:0%"></div></div>
    </div>
  </div>

  <div class="controls">
    <label style="color:#888;font-size:13px;">From</label>
    <input type="date" id="date-from" />
    <label style="color:#888;font-size:13px;">To</label>
    <input type="date" id="date-to" />
    <button id="btn-analyze" onclick="loadDashboard()">Analyze</button>
  </div>

  <div id="error-box" class="error-msg hidden"></div>
  <div id="loading" class="loading hidden"><div class="spinner"></div><div>Loading video data...</div></div>

  <div id="summary-cards" class="cards hidden"></div>
  <div id="alerts" class="alerts hidden"></div>
  <div id="video-table" class="table-wrap hidden"></div>
</div>
<div id="detail-view">
  <div class="detail-inner" id="detail-content"></div>
</div>

<script>
// ‚îÄ‚îÄ State ‚îÄ‚îÄ
let allVideos = [];
let currentSort = { col: 'score', dir: 'desc' };
let selectedVideoId = null;
let aiAvailable = false;
let rewriteAvailable = false;
let activeExpertTab = 0;
let currentAIAnalysis = null; // Store for rewriter access
let generatedCROBatches = {}; // { 'expert0': [batch1, batch2, ...] }
let videoContexts = {}; // { 'videoId': 'context text' }
let currentVideoDetail = null; // { analysis, dropOff, stats } for report

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ
(function init() {
  const now = new Date();
  const from = new Date(now);
  from.setDate(from.getDate() - 30);
  document.getElementById('date-from').value = fmt(from);
  document.getElementById('date-to').value = fmt(now);
  loadUsage();
  loadAIStatus();
  loadRewriteStatus();
  loadDashboard();
})();

function fmt(d) {
  return d.toISOString().split('T')[0];
}

async function loadUsage() {
  try {
    const res = await fetch('/api/usage');
    const u = await res.json();
    const pct = u.monthlyLimit ? Math.round((u.currentUsage / u.monthlyLimit) * 100) : 0;
    document.getElementById('usage-text').textContent = `API: ${u.currentUsage.toLocaleString()}/${(u.monthlyLimit||'‚àû').toLocaleString()}`;
    document.getElementById('usage-fill').style.width = pct + '%';
  } catch {}
}

async function loadAIStatus() {
  try {
    const res = await fetch('/api/ai-status');
    const data = await res.json();
    aiAvailable = data.available;
  } catch { aiAvailable = false; }
}

async function loadRewriteStatus() {
  try {
    const res = await fetch('/api/rewrite-status');
    const data = await res.json();
    rewriteAvailable = data.available;
  } catch { rewriteAvailable = false; }
}

const REWRITE_STEPS = [
  { icon: 'üìã', label: 'Prepare' },
  { icon: '‚úçÔ∏è', label: 'Rewrite' },
  { icon: 'üìù', label: 'Format' },
  { icon: '‚úÖ', label: 'Done' },
];

function renderRewriteProgress(step, totalSteps, label, detail) {
  const pct = Math.round((step / totalSteps) * 100);
  return `
    <div class="ai-loading">
      <div class="rewrite-progress-wrap">
        <div class="ai-progress-bar"><div class="ai-progress-fill" style="width:${pct}%;background:linear-gradient(90deg,#f59e0b,#ef4444)"></div></div>
        <div class="rewrite-steps">
          ${REWRITE_STEPS.map((s, i) => {
            const cls = i < step ? 'done' : i === step ? 'active' : '';
            const icon = i < step ? '‚úì' : s.icon;
            return `<div class="rewrite-step ${cls}"><span class="rewrite-step-icon">${icon}</span>${s.label}</div>`;
          }).join('')}
        </div>
        <div class="ai-progress-label">${esc(label)}</div>
        <div class="ai-progress-detail">${esc(detail || '')}</div>
      </div>
    </div>`;
}

const CRO_GEN_STEPS = [
  { icon: 'üìã', label: 'Prepare' },
  { icon: 'üß™', label: 'Generate' },
  { icon: '‚úÖ', label: 'Done' },
];

function renderCROGenProgress(step, totalSteps, label, detail) {
  const pct = Math.round((step / totalSteps) * 100);
  return `
    <div class="ai-loading">
      <div style="margin-top:16px;">
        <div class="ai-progress-bar"><div class="ai-progress-fill" style="width:${pct}%;background:linear-gradient(90deg,#10b981,#3b82f6)"></div></div>
        <div class="cro-gen-steps">
          ${CRO_GEN_STEPS.map((s, i) => {
            const cls = i < step ? 'done' : i === step ? 'active' : '';
            const icon = i < step ? '‚úì' : s.icon;
            return `<div class="cro-gen-step ${cls}"><span class="cro-gen-step-icon">${icon}</span>${s.label}</div>`;
          }).join('')}
        </div>
        <div class="ai-progress-label">${esc(label)}</div>
        <div class="ai-progress-detail">${esc(detail || '')}</div>
      </div>
    </div>`;
}

async function loadNewCROTests(videoId, expertIndex, expertName) {
  const container = document.getElementById('cro-gen-container-' + expertIndex);
  if (!container) return;

  const btn = document.getElementById('cro-gen-btn-' + expertIndex);
  if (btn) btn.disabled = true;

  const progressEl = document.getElementById('cro-gen-progress-' + expertIndex);
  if (progressEl) {
    progressEl.innerHTML = renderCROGenProgress(0, 3, 'Starting...', 'Connecting to Claude...');
  }

  const from = document.getElementById('date-from').value;
  const to = document.getElementById('date-to').value;

  try {
    const url = `/api/videos/${videoId}/generate-cro-tests?expert=${expertIndex}&from=${from}&to=${to}&stream=1${encodeContext()}`;
    const eventSource = new EventSource(url);

    await new Promise((resolve, reject) => {
      eventSource.addEventListener('progress', (e) => {
        const d = JSON.parse(e.data);
        if (progressEl) {
          progressEl.innerHTML = renderCROGenProgress(d.step, d.totalSteps, d.label, d.detail);
        }
      });

      eventSource.addEventListener('complete', (e) => {
        eventSource.close();
        const data = JSON.parse(e.data);
        if (!data.generatedTests) {
          reject(new Error('No test data returned.'));
          return;
        }

        const key = 'expert' + expertIndex;
        if (!generatedCROBatches[key]) generatedCROBatches[key] = [];
        generatedCROBatches[key].push(data.generatedTests);

        renderGeneratedBatches(expertIndex);

        if (progressEl) progressEl.innerHTML = '';
        if (btn) btn.disabled = false;
        resolve();
      });

      eventSource.addEventListener('error', (e) => {
        eventSource.close();
        try {
          const d = JSON.parse(e.data);
          reject(new Error(d.error || 'CRO test generation failed'));
        } catch {
          reject(new Error('Connection lost during CRO test generation.'));
        }
      });

      eventSource.onerror = () => {
        eventSource.close();
        reject(new Error('Connection lost. Please try again.'));
      };
    });
  } catch (err) {
    if (progressEl) progressEl.innerHTML = `<div class="error-msg">CRO Generation Error: ${esc(err.message)}</div>`;
    if (btn) btn.disabled = false;
  }
}

function renderGeneratedBatches(expertIndex) {
  const container = document.getElementById('cro-gen-container-' + expertIndex);
  if (!container) return;

  const key = 'expert' + expertIndex;
  const batches = generatedCROBatches[key] || [];

  if (batches.length === 0) {
    container.innerHTML = '';
    return;
  }

  const reversedBatches = [...batches].reverse();

  container.innerHTML = `
    <div class="generated-batches">
      ${reversedBatches.map((batch, displayIdx) => {
        const isNewest = displayIdx === 0;
        return `
          <div class="generated-batch">
            <div class="generated-batch-header" onclick="toggleGeneratedBatch(${expertIndex}, ${batch.batchNumber})">
              <div class="generated-batch-title">
                <span class="new-badge">NEW</span>
                Batch #${batch.batchNumber} ‚Äî ${batch.tests.length} Tests
                <span style="color:#888;font-size:11px;font-weight:400;">(${timeAgo(new Date(batch.generatedAt).getTime())})</span>
              </div>
              <span class="generated-batch-toggle" id="cro-batch-toggle-${expertIndex}-${batch.batchNumber}">${isNewest ? '‚ñº' : '‚ñ∂'}</span>
            </div>
            <div class="generated-batch-body${isNewest ? '' : ' collapsed'}" id="cro-batch-body-${expertIndex}-${batch.batchNumber}">
              <div style="padding:12px;">
                ${batch.tests.map(t => `
                  <div class="cro-card" style="border-left:3px solid #10b981;">
                    <div class="cro-name">${esc(t.testName)}</div>
                    <div class="cro-row"><span class="cro-label">Hypothesis</span><span class="cro-value">${esc(t.hypothesis)}</span></div>
                    <div class="cro-row"><span class="cro-label">Control</span><span class="cro-value">${esc(t.control)}</span></div>
                    <div class="cro-row"><span class="cro-label">Variant</span><span class="cro-value">${esc(t.variant)}</span></div>
                    <div class="cro-row"><span class="cro-label">Impact</span><span class="cro-value">${esc(t.expectedImpact)}</span></div>
                    <div class="cro-row"><span class="cro-label">How To</span><span class="cro-value">${esc(t.implementation)}</span></div>
                  </div>
                `).join('')}
              </div>
            </div>
          </div>
        `;
      }).join('')}
    </div>
  `;
}

function toggleGeneratedBatch(expertIndex, batchNumber) {
  const body = document.getElementById('cro-batch-body-' + expertIndex + '-' + batchNumber);
  const toggle = document.getElementById('cro-batch-toggle-' + expertIndex + '-' + batchNumber);
  if (!body || !toggle) return;
  body.classList.toggle('collapsed');
  toggle.textContent = body.classList.contains('collapsed') ? '‚ñ∂' : '‚ñº';
}

async function loadScriptRewrite(videoId, expertIndex, expertName) {
  const container = document.getElementById('rewrite-container-' + expertIndex);
  if (!container) return;

  // Disable the button
  const btn = document.getElementById('rewrite-btn-' + expertIndex);
  if (btn) btn.disabled = true;

  // Show initial progress
  container.innerHTML = renderRewriteProgress(0, 4, 'Starting script rewrite...', 'Connecting to Claude...');

  const from = document.getElementById('date-from').value;
  const to = document.getElementById('date-to').value;

  try {
    const url = `/api/videos/${videoId}/rewrite-script?expert=${expertIndex}&from=${from}&to=${to}&stream=1${encodeContext()}`;
    const eventSource = new EventSource(url);

    await new Promise((resolve, reject) => {
      eventSource.addEventListener('progress', (e) => {
        const d = JSON.parse(e.data);
        container.innerHTML = renderRewriteProgress(d.step, d.totalSteps, d.label, d.detail);
      });

      eventSource.addEventListener('complete', (e) => {
        eventSource.close();
        const data = JSON.parse(e.data);
        if (!data.rewrittenScript) {
          reject(new Error('No rewrite data returned.'));
          return;
        }
        renderRewrittenScript(data, container);
        resolve();
      });

      eventSource.addEventListener('error', (e) => {
        eventSource.close();
        try {
          const d = JSON.parse(e.data);
          reject(new Error(d.error || 'Script rewrite failed'));
        } catch {
          reject(new Error('Connection lost during script rewrite.'));
        }
      });

      eventSource.onerror = () => {
        eventSource.close();
        reject(new Error('Connection lost. Please try again.'));
      };
    });
  } catch (err) {
    container.innerHTML = `<div class="error-msg">Script Rewrite Error: ${esc(err.message)}</div>`;
    if (btn) btn.disabled = false;
  }
}

function renderRewrittenScript(data, container) {
  const { rewrittenScript: r, cached, cachedAt } = data;

  const cacheInfo = cached
    ? `<span class="rewrite-cache-info">Cached ${timeAgo(cachedAt)}</span>`
    : '';

  const sectionsHtml = r.sections.map((s, i) => `
    <div class="rewrite-section">
      <div class="rewrite-section-header" onclick="toggleRewriteSection(${i})">
        <span class="rewrite-section-name">${esc(s.sectionName)}</span>
        <span class="rewrite-section-toggle" id="rewrite-toggle-${i}">‚ñº</span>
      </div>
      <div class="rewrite-section-body" id="rewrite-body-${i}">
        <div class="rewrite-columns">
          <div class="rewrite-col">
            <div class="rewrite-col-label original">Original Script</div>
            <div class="rewrite-col-text">${esc(s.originalText)}</div>
          </div>
          <div class="rewrite-col">
            <div class="rewrite-col-label rewritten">Rewritten by ${esc(r.expertName)}</div>
            <div class="rewrite-col-text">${esc(s.rewrittenText)}</div>
          </div>
        </div>
        <div class="rewrite-explanation">
          <div class="rewrite-explanation-label">Changes Explained</div>
          <div class="rewrite-explanation-text">${esc(s.changesExplained)}</div>
          <div class="rewrite-principle">${esc(s.expertPrinciple)}</div>
        </div>
      </div>
    </div>
  `).join('');

  container.innerHTML = `
    <div style="margin-top:16px;">
      ${cacheInfo}
      <div class="rewrite-summary">
        <div class="rewrite-summary-title">Script Rewrite by ${esc(r.expertName)}</div>
        <div class="rewrite-summary-text">${esc(r.changesSummary)}</div>
      </div>

      ${sectionsHtml}

      <button class="rewrite-full-toggle" onclick="toggleFullScript()">
        üìÑ View Full Rewritten Script
      </button>
      <div class="rewrite-full-script" id="rewrite-full-script">
        <div class="rewrite-full-script-text">${esc(r.fullRewrittenScript)}</div>
      </div>
    </div>
  `;
}

function toggleRewriteSection(index) {
  const body = document.getElementById('rewrite-body-' + index);
  const toggle = document.getElementById('rewrite-toggle-' + index);
  if (!body || !toggle) return;
  body.classList.toggle('collapsed');
  toggle.textContent = body.classList.contains('collapsed') ? '‚ñ∂' : '‚ñº';
}

function toggleFullScript() {
  const el = document.getElementById('rewrite-full-script');
  if (el) el.classList.toggle('visible');
}

const AI_STEPS = [
  { icon: 'üìã', label: 'Load data' },
  { icon: 'üì•', label: 'Download' },
  { icon: '‚òÅÔ∏è', label: 'Upload' },
  { icon: 'üîÑ', label: 'Process' },
  { icon: 'üß†', label: 'Analyze' },
  { icon: 'üìä', label: 'Report' },
];

function renderProgressBar(step, totalSteps, label, detail) {
  const pct = Math.round((step / totalSteps) * 100);
  return `
    <div class="ai-loading">
      <div class="ai-progress-wrap">
        <div class="ai-progress-bar"><div class="ai-progress-fill" style="width:${pct}%"></div></div>
        <div class="ai-steps">
          ${AI_STEPS.map((s, i) => {
            const cls = i < step ? 'done' : i === step ? 'active' : '';
            const icon = i < step ? '‚úì' : s.icon;
            return `<div class="ai-step ${cls}"><span class="ai-step-icon">${icon}</span>${s.label}</div>`;
          }).join('')}
        </div>
        <div class="ai-progress-label">${esc(label)}</div>
        <div class="ai-progress-detail">${esc(detail || '')}</div>
      </div>
    </div>`;
}

function getVideoContext() {
  const el = document.getElementById('video-context');
  return el ? el.value.trim() : '';
}

function saveVideoContext(videoId) {
  const ctx = getVideoContext();
  if (ctx) videoContexts[videoId] = ctx;
}

function encodeContext() {
  const ctx = getVideoContext();
  return ctx ? '&context=' + encodeURIComponent(ctx) : '';
}

async function loadAIAnalysis(videoId) {
  const container = document.getElementById('ai-container');
  if (!container) return;

  // Show initial progress bar
  container.innerHTML = renderProgressBar(0, 6, 'Starting analysis...', 'Connecting to server...');

  const from = document.getElementById('date-from').value;
  const to = document.getElementById('date-to').value;

  try {
    // Save context for this video
    saveVideoContext(videoId);

    // Use SSE for real-time progress
    const url = `/api/videos/${videoId}/content-analysis?from=${from}&to=${to}&stream=1${encodeContext()}`;
    const eventSource = new EventSource(url);

    await new Promise((resolve, reject) => {
      eventSource.addEventListener('progress', (e) => {
        const d = JSON.parse(e.data);
        container.innerHTML = renderProgressBar(d.step, d.totalSteps, d.label, d.detail);
      });

      eventSource.addEventListener('complete', (e) => {
        eventSource.close();
        const data = JSON.parse(e.data);
        if (!data.analysis) {
          reject(new Error('No analysis data returned.'));
          return;
        }
        renderAIAnalysis(data, container);
        resolve();
      });

      eventSource.addEventListener('error', (e) => {
        eventSource.close();
        try {
          const d = JSON.parse(e.data);
          reject(new Error(d.error || 'Analysis failed'));
        } catch {
          reject(new Error('Connection lost. The video may be too large to process.'));
        }
      });

      eventSource.onerror = () => {
        eventSource.close();
        reject(new Error('Connection lost. The server may have run out of memory processing this video.'));
      };
    });
  } catch (err) {
    container.innerHTML = `<div class="error-msg">AI Analysis Error: ${esc(err.message)}</div>`;
  }
}

async function loadDashboard() {
  const from = document.getElementById('date-from').value;
  const to = document.getElementById('date-to').value;
  const btn = document.getElementById('btn-analyze');

  show('loading'); hide('error-box'); hide('summary-cards'); hide('alerts'); hide('video-table');
  btn.disabled = true;

  try {
    const [videosRes, summaryRes] = await Promise.all([
      fetch(`/api/videos?from=${from}&to=${to}`).then(r => r.json()),
      fetch(`/api/summary?from=${from}&to=${to}`).then(r => r.json()),
    ]);

    if (videosRes.error) throw new Error(videosRes.error);
    if (summaryRes.error) throw new Error(summaryRes.error);

    allVideos = videosRes.videos;
    renderSummary(summaryRes.summary);
    renderAlerts(summaryRes.summary);
    renderTable(allVideos);
    show('summary-cards'); show('video-table');
    if (summaryRes.summary.portfolioRecommendations.length > 0) show('alerts');
  } catch (err) {
    document.getElementById('error-box').textContent = err.message;
    show('error-box');
  } finally {
    hide('loading');
    btn.disabled = false;
    loadUsage();
  }
}

// ‚îÄ‚îÄ Render Summary Cards ‚îÄ‚îÄ
function renderSummary(s) {
  document.getElementById('summary-cards').innerHTML = `
    <div class="card"><div class="card-label">Total Plays</div><div class="card-value">${s.totalPlays.toLocaleString()}</div><div class="card-sub">${s.totalVideos} videos</div></div>
    <div class="card"><div class="card-label">Avg Engagement</div><div class="card-value">${(s.avgEngagement*100).toFixed(1)}%</div><div class="card-sub">of video watched</div></div>
    <div class="card"><div class="card-label">Avg Play Rate</div><div class="card-value">${(s.avgPlayRate*100).toFixed(1)}%</div><div class="card-sub">visitors who press play</div></div>
    <div class="card"><div class="card-label">Revenue</div><div class="card-value">$${s.totalRevenue.toFixed(2)}</div><div class="card-sub">${s.totalConversions} conversions</div></div>
  `;
}

// ‚îÄ‚îÄ Render Alerts ‚îÄ‚îÄ
function renderAlerts(s) {
  const el = document.getElementById('alerts');
  el.innerHTML = s.portfolioRecommendations.map(r => `
    <div class="alert alert-${r.type}">
      <div class="alert-title">${esc(r.title)}</div>
      <div>${esc(r.detail)}</div>
      <div class="alert-action">${esc(r.actionableStep)}</div>
    </div>
  `).join('');
}

// ‚îÄ‚îÄ Render Video Table ‚îÄ‚îÄ
function renderTable(videos) {
  const arrow = (col) => currentSort.col === col ? (currentSort.dir === 'asc' ? ' ‚Üë' : ' ‚Üì') : '';
  document.getElementById('video-table').innerHTML = `<table>
    <thead><tr>
      <th onclick="sortBy('title')">Video${arrow('title')}</th>
      <th onclick="sortBy('plays')">Plays${arrow('plays')}</th>
      <th onclick="sortBy('engagement')">Engagement${arrow('engagement')}</th>
      <th onclick="sortBy('playRate')">Play Rate${arrow('playRate')}</th>
      <th onclick="sortBy('unmuteRate')">Unmute${arrow('unmuteRate')}</th>
      <th onclick="sortBy('conversionRate')">Conv %${arrow('conversionRate')}</th>
      <th onclick="sortBy('score')">Score${arrow('score')}</th>
    </tr></thead>
    <tbody>${videos.map(v => {
      const s = v.stats;
      const sel = v.id === selectedVideoId ? ' selected' : '';
      return `<tr class="clickable${sel}" onclick="selectVideo('${v.id}')">
        <td class="video-name" title="${esc(v.title)}">${esc(v.title)}</td>
        <td>${s ? s.plays.toLocaleString() : '‚Äî'}</td>
        <td>${s ? (s.engagement*100).toFixed(1)+'%' : '‚Äî'}</td>
        <td>${s ? (s.playRate*100).toFixed(1)+'%' : '‚Äî'}</td>
        <td>${s ? (s.unmuteRate*100).toFixed(1)+'%' : '‚Äî'}</td>
        <td>${s ? (s.conversionRate*100).toFixed(2)+'%' : '‚Äî'}</td>
        <td><span class="badge badge-${v.rating}">${v.score}</span></td>
      </tr>`;
    }).join('')}</tbody></table>`;
}

function sortBy(col) {
  if (currentSort.col === col) {
    currentSort.dir = currentSort.dir === 'asc' ? 'desc' : 'asc';
  } else {
    currentSort = { col, dir: col === 'title' ? 'asc' : 'desc' };
  }
  allVideos.sort((a, b) => {
    let va, vb;
    if (col === 'title') { va = a.title.toLowerCase(); vb = b.title.toLowerCase(); }
    else if (col === 'score') { va = a.score; vb = b.score; }
    else { va = a.stats?.[col] ?? 0; vb = b.stats?.[col] ?? 0; }
    if (va < vb) return currentSort.dir === 'asc' ? -1 : 1;
    if (va > vb) return currentSort.dir === 'asc' ? 1 : -1;
    return 0;
  });
  renderTable(allVideos);
}

// ‚îÄ‚îÄ Video Detail (full-screen view) ‚îÄ‚îÄ
function closeDetail() {
  document.getElementById('detail-view').classList.remove('visible');
  document.body.style.overflow = '';
  selectedVideoId = null;
  renderTable(allVideos);
}

async function selectVideo(id) {
  selectedVideoId = id;
  renderTable(allVideos);

  const view = document.getElementById('detail-view');
  const content = document.getElementById('detail-content');
  view.classList.add('visible');
  view.scrollTop = 0;
  document.body.style.overflow = 'hidden';
  content.innerHTML = '<div class="loading"><div class="spinner"></div><div>Loading analysis...</div></div>';

  const from = document.getElementById('date-from').value;
  const to = document.getElementById('date-to').value;

  try {
    const res = await fetch(`/api/videos/${id}/analysis?from=${from}&to=${to}`);
    const data = await res.json();
    if (data.error) throw new Error(data.error);
    renderDetail(data);
  } catch (err) {
    content.innerHTML = `<div class="detail-topbar"><button class="back-btn" onclick="closeDetail()">‚Üê Back to Dashboard</button></div><div class="error-msg">${esc(err.message)}</div>`;
  }
}

function renderDetail(data) {
  currentVideoDetail = data;
  const { analysis, dropOff, stats } = data;
  const a = analysis;
  const content = document.getElementById('detail-content');

  content.innerHTML = `
    <div class="detail-topbar">
      <button class="back-btn" onclick="closeDetail()">‚Üê Back to Dashboard</button>
      <div class="detail-score badge badge-${a.overallRating}">${a.overallScore}/100</div>
      <div class="detail-title">${esc(a.videoName)}</div>
      <button class="report-btn" onclick="generateReport()" id="report-download-btn">Download Client Report</button>
    </div>

    <div class="metrics-grid">
      ${metricCard('Play Rate', a.metrics.playRate)}
      ${metricCard('Engagement', a.metrics.engagement)}
      ${metricCard('Conv Rate', a.metrics.conversionRate)}
      ${metricCard('Unmute Rate', a.metrics.unmuteRate)}
    </div>

    <div class="chart-section">
      <h3>Viewer Retention</h3>
      ${renderChart(dropOff, a.significantDrops)}
    </div>

    ${a.significantDrops.length > 0 ? `
    <div class="drops-section">
      <h3>Significant Drop-off Points</h3>
      <div style="color:#888;font-size:12px;margin-bottom:10px;">Drops across full video timeline ‚Äî relative % shows how many current viewers left at each point</div>
      ${a.significantDrops.map(d => `
        <div class="drop-item">
          <div class="drop-time">${d.formattedTime}</div>
          <span class="badge badge-${d.severity || 'average'}" style="font-size:10px;padding:2px 6px;margin-right:6px;">${(d.segment || 'early').replace('-', ' ')}</span>
          <div class="drop-detail">${d.viewersBefore} ‚Üí ${d.viewersAfter} viewers</div>
          <div class="drop-pct" title="Relative: ${d.relativeDrop || d.dropPercentage}% of current viewers">-${d.relativeDrop || d.dropPercentage}% rel</div>
        </div>
      `).join('')}
    </div>` : ''}

    <div class="recs-section">
      <h3>Recommendations</h3>
      ${a.recommendations.map(r => `
        <div class="rec-card rec-${r.type}">
          <div class="rec-title">${esc(r.title)}</div>
          <div class="rec-detail">${esc(r.detail)}</div>
          <div class="rec-action">${esc(r.actionableStep)}</div>
        </div>
      `).join('')}
    </div>

    ${aiAvailable ? `
    <div class="ai-section">
      <h3 style="color:#fff;font-size:16px;margin-bottom:12px;">AI Content Analysis</h3>
      <p style="color:#888;font-size:13px;margin-bottom:12px;">
        Uses Google Gemini to watch your actual video, analyze the content at drop-off points, and provide expert feedback from 5 direct response marketing legends.
      </p>
      <div class="context-section">
        <div class="context-label">
          Video Context <span class="optional-tag">Optional</span>
        </div>
        <textarea class="context-textarea" id="video-context"
          placeholder="e.g. This is a post-purchase upsell video for buyers of our $97 fitness program. The audience already bought the core product and this offers a $197 advanced coaching add-on. It appears right after checkout."
        >${esc(videoContexts[a.videoId] || '')}</textarea>
      </div>
      <button class="ai-btn" id="ai-analyze-btn" onclick="loadAIAnalysis('${a.videoId}')">
        Analyze Video Content with AI
      </button>
      <div id="ai-container"></div>
    </div>` : ''}
  `;
}

function metricCard(label, m) {
  const pct = m.value < 1 ? (m.value * 100).toFixed(1) + '%' : m.value.toFixed(1);
  return `<div class="metric-card">
    <div class="metric-label">${label}</div>
    <div class="metric-value">${pct}</div>
    <div class="metric-rating"><span class="badge badge-${m.rating}">${m.rating}</span></div>
  </div>`;
}

function renderChart(dropOff, significantDrops) {
  if (!dropOff || !dropOff.points || dropOff.points.length === 0) {
    return '<div style="color:#888;padding:20px;text-align:center;">No drop-off data available</div>';
  }
  const pts = dropOff.points;
  const max = dropOff.totalViewers || pts[0].viewers;
  const dropSeconds = new Set(significantDrops.map(d => d.second));

  const bars = pts.map(p => {
    const h = max > 0 ? (p.viewers / max) * 100 : 0;
    const isDrop = dropSeconds.has(p.second);
    return `<div class="chart-bar${isDrop ? ' drop-bar' : ''}" style="height:${h}%">
      <div class="chart-tooltip">${p.formattedTime} ‚Äî ${p.percentRemaining.toFixed(0)}% (${p.viewers})</div>
    </div>`;
  }).join('');

  const first = pts[0];
  const mid = pts[Math.floor(pts.length / 2)];
  const last = pts[pts.length - 1];

  return `<div class="chart-container"><div class="chart-bars">${bars}</div></div>
    <div class="chart-labels">
      <span>${first.formattedTime}</span>
      <span>${mid.formattedTime}</span>
      <span>${last.formattedTime}</span>
    </div>`;
}

// ‚îÄ‚îÄ AI Analysis Rendering ‚îÄ‚îÄ
function renderAIAnalysis(data, container) {
  const { analysis, cached, cachedAt } = data;
  const a = analysis;
  activeExpertTab = 0;
  currentAIAnalysis = a; // Store for rewriter
  generatedCROBatches = {}; // Reset generated batches for new analysis

  const cacheInfo = cached
    ? `<span class="ai-cache-info">Cached ${timeAgo(cachedAt)}</span>`
    : '';

  container.innerHTML = `
    <div style="margin-top:20px;">
      ${cacheInfo}

      <!-- Verdict -->
      <div class="verdict-box">
        <div class="verdict-title">Overall Verdict</div>
        <div class="verdict-text">${esc(a.overallVerdict)}</div>
      </div>

      <!-- Expert Feedback -->
      <div style="margin-top:24px;">
        <h3 style="color:#fff;font-size:16px;margin-bottom:12px;">Expert Feedback</h3>
        <div class="expert-tabs">
          ${a.expertFeedback.map((e, i) => `
            <div class="expert-tab${i === 0 ? ' active' : ''}" onclick="switchExpertTab(${i})" id="exp-tab-${i}">
              ${esc(e.expertName)}
            </div>
          `).join('')}
        </div>
        ${a.expertFeedback.map((e, i) => renderExpertPanel(e, i)).join('')}
      </div>

      <!-- Timestamp Analysis -->
      ${a.timestampAnalysis.length > 0 ? `
      <div class="timestamp-section">
        <h3>Drop-off Content Analysis</h3>
        <p style="color:#888;font-size:13px;margin-bottom:12px;">What's happening in the video at every major drop-off point across the full timeline</p>
        ${a.timestampAnalysis.map(ts => `
          <div class="ts-card">
            <div class="ts-time">${esc(ts.formattedTime || ts.timestamp)}</div>
            <div class="ts-row"><span class="ts-label">On Screen: </span><span class="ts-content">${esc(ts.contentDescription)}</span></div>
            <div class="ts-row"><span class="ts-label">Audio: </span><span class="ts-content">${esc(ts.audioDescription)}</span></div>
            <div class="ts-row"><span class="ts-label">Issue: </span><span class="ts-issue">${esc(ts.issue)}</span></div>
            <div class="ts-row"><span class="ts-label">Fix: </span><span class="ts-fix">${esc(ts.fix)}</span></div>
          </div>
        `).join('')}
      </div>` : ''}

      <!-- CRO Tests are now inside each expert tab -->

      <!-- Script Structure -->
      ${a.scriptStructure ? `
      <div class="script-section">
        <h3>Script Structure Analysis</h3>
        <div class="script-grid">
          ${renderScriptCard('Hook', a.scriptStructure.hook)}
          ${renderScriptCard('Problem', a.scriptStructure.problem)}
          ${renderScriptCard('Solution', a.scriptStructure.solution)}
          ${renderScriptCard('Proof', a.scriptStructure.proof)}
          ${renderScriptCard('CTA', a.scriptStructure.cta)}
        </div>
        <div class="script-flow">
          <div class="script-label">Overall Flow</div>
          <div class="script-text">${esc(a.scriptStructure.overallFlow)}</div>
        </div>
      </div>` : ''}
    </div>
  `;
}

function renderExpertPanel(expert, index) {
  const videoId = selectedVideoId;
  return `
    <div class="expert-panel${index === 0 ? ' active' : ''}" id="exp-panel-${index}">
      <div class="expert-header">
        <div>
          <div class="expert-name">${esc(expert.expertName)}</div>
          <div class="expert-role">${esc(expert.expertRole)}</div>
        </div>
      </div>
      <div class="expert-assessment">${esc(expert.overallAssessment)}</div>

      ${expert.strengths.length > 0 ? `
      <div class="expert-strengths">
        <h4>Strengths</h4>
        <ul class="expert-list">${expert.strengths.map(s => `<li>${esc(s)}</li>`).join('')}</ul>
      </div>` : ''}

      ${expert.weaknesses.length > 0 ? `
      <div class="expert-weaknesses">
        <h4>Weaknesses</h4>
        <ul class="expert-list">${expert.weaknesses.map(w => `<li>${esc(w)}</li>`).join('')}</ul>
      </div>` : ''}

      ${expert.specificFixes.length > 0 ? `
      <div class="expert-fixes">
        <h4>Specific Fixes</h4>
        ${expert.specificFixes.map(f => `
          <div class="fix-item">
            <div class="fix-timestamp">${esc(f.timestamp)}</div>
            <div class="fix-issue">${esc(f.issue)}</div>
            <div class="fix-solution">${esc(f.fix)}</div>
          </div>
        `).join('')}
      </div>` : ''}

      <div class="expert-priority">
        <h4>#1 Priority Action</h4>
        <p>${esc(expert.priorityAction)}</p>
      </div>

      ${(expert.croTests && expert.croTests.length > 0) ? `
      <div class="cro-section" style="margin-top:16px;">
        <h4 style="color:#7c3aed;font-size:13px;margin-bottom:8px;">CRO Tests from ${esc(expert.expertName)}</h4>
        ${expert.croTests.map(t => `
          <div class="cro-card">
            <div class="cro-name">${esc(t.testName)}</div>
            <div class="cro-row"><span class="cro-label">Hypothesis</span><span class="cro-value">${esc(t.hypothesis)}</span></div>
            <div class="cro-row"><span class="cro-label">Control</span><span class="cro-value">${esc(t.control)}</span></div>
            <div class="cro-row"><span class="cro-label">Variant</span><span class="cro-value">${esc(t.variant)}</span></div>
            <div class="cro-row"><span class="cro-label">Impact</span><span class="cro-value">${esc(t.expectedImpact)}</span></div>
            <div class="cro-row"><span class="cro-label">How To</span><span class="cro-value">${esc(t.implementation)}</span></div>
          </div>
        `).join('')}
      </div>` : ''}

      ${rewriteAvailable ? `
      <div style="margin-top:16px; padding-top:16px; border-top:1px solid #262626;">
        <button class="generate-cro-btn" id="cro-gen-btn-${index}" onclick="loadNewCROTests('${videoId}', ${index}, '${esc(expert.expertName)}')">
          üß™ Generate New Split Test Ideas
        </button>
        <div id="cro-gen-progress-${index}"></div>
        <div id="cro-gen-container-${index}"></div>
      </div>` : ''}

      ${rewriteAvailable ? `
      <div style="margin-top:20px; padding-top:16px; border-top:1px solid #333;">
        <button class="rewrite-btn" id="rewrite-btn-${index}" onclick="loadScriptRewrite('${videoId}', ${index}, '${esc(expert.expertName)}')">
          ‚úçÔ∏è Rewrite Script as ${esc(expert.expertName)}
        </button>
        <div class="rewrite-container" id="rewrite-container-${index}"></div>
      </div>` : ''}
    </div>
  `;
}

function switchExpertTab(index) {
  // Deactivate all
  document.querySelectorAll('.expert-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.expert-panel').forEach(p => p.classList.remove('active'));
  // Activate selected
  document.getElementById('exp-tab-' + index)?.classList.add('active');
  document.getElementById('exp-panel-' + index)?.classList.add('active');
  activeExpertTab = index;
}

function renderScriptCard(label, text) {
  if (!text) return '';
  return `<div class="script-card">
    <div class="script-label">${label}</div>
    <div class="script-text">${esc(text)}</div>
  </div>`;
}

function timeAgo(ts) {
  if (!ts) return '';
  const diff = Date.now() - ts;
  const mins = Math.floor(diff / 60000);
  if (mins < 60) return `${mins}m ago`;
  const hrs = Math.floor(mins / 60);
  if (hrs < 24) return `${hrs}h ago`;
  const days = Math.floor(hrs / 24);
  return `${days}d ago`;
}

// ‚îÄ‚îÄ PDF Report Generation ‚îÄ‚îÄ

const PDF_COLORS = {
  primary:     [59, 130, 246],
  secondary:   [124, 58, 237],
  dark:        [15, 15, 15],
  text:        [51, 51, 51],
  textLight:   [136, 136, 136],
  white:       [255, 255, 255],
  bgLight:     [248, 250, 252],
  excellent:   [34, 197, 94],
  good:        [59, 130, 246],
  average:     [200, 160, 20],
  poor:        [251, 146, 60],
  critical:    [220, 80, 80],
  tableBorder: [226, 232, 240],
  tableHeader: [30, 41, 59],
  emerald:     [16, 185, 129],
};

function ratingColor(rating) {
  return PDF_COLORS[rating] || PDF_COLORS.text;
}

function fmtPct(val) {
  if (val == null) return 'N/A';
  return val < 1 ? (val * 100).toFixed(1) + '%' : val.toFixed(1) + '%';
}

function sanitizeFn(str) {
  return str.replace(/[^a-zA-Z0-9_\- ]/g, '').substring(0, 50).trim().replace(/\s+/g, '_');
}

function generateReport() {
  const btn = document.getElementById('report-download-btn');
  if (!currentVideoDetail) { alert('No video data loaded.'); return; }
  if (btn) { btn.disabled = true; btn.textContent = 'Generating...'; }

  try {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
    const PW = 210, PH = 297, M = 15, CW = PW - 2 * M;
    let y = M;

    const { analysis: a, dropOff, stats } = currentVideoDetail;
    const ai = currentAIAnalysis;

    function needPage(needed) {
      if (y + needed > PH - 20) { doc.addPage(); y = M; }
    }

    function sectionTitle(title) {
      needPage(18);
      doc.setFontSize(15); doc.setFont('helvetica', 'bold');
      doc.setTextColor(...PDF_COLORS.dark);
      doc.text(title, M, y); y += 3;
      doc.setDrawColor(...PDF_COLORS.primary);
      doc.setLineWidth(0.5);
      doc.line(M, y, M + CW, y); y += 7;
    }

    function subTitle(title) {
      needPage(10);
      doc.setFontSize(11); doc.setFont('helvetica', 'bold');
      doc.setTextColor(...PDF_COLORS.secondary);
      doc.text(title, M, y); y += 6;
    }

    function bodyText(text, indent) {
      const ind = indent || 0;
      doc.setFontSize(9); doc.setFont('helvetica', 'normal');
      doc.setTextColor(...PDF_COLORS.text);
      const lines = doc.splitTextToSize(text, CW - ind);
      needPage(lines.length * 4 + 2);
      doc.text(lines, M + ind, y);
      y += lines.length * 4 + 2;
    }

    // ===== SECTION 1: COVER =====
    doc.setFillColor(...PDF_COLORS.primary);
    doc.rect(0, 0, PW, 48, 'F');
    // Accent stripe
    doc.setFillColor(...PDF_COLORS.secondary);
    doc.rect(0, 48, PW, 3, 'F');

    doc.setTextColor(...PDF_COLORS.white);
    doc.setFontSize(26); doc.setFont('helvetica', 'bold');
    doc.text('Video Performance Report', M, 20);

    doc.setFontSize(13); doc.setFont('helvetica', 'normal');
    const titleLines = doc.splitTextToSize(a.videoName, CW - 40);
    doc.text(titleLines, M, 30);

    doc.setFontSize(10);
    doc.text('Analysis Date: ' + new Date().toLocaleDateString('en-US', { year:'numeric', month:'long', day:'numeric' }), M, 42);

    // Score badge
    const sx = PW - M - 14;
    doc.setFillColor(...ratingColor(a.overallRating));
    doc.circle(sx, 22, 13, 'F');
    doc.setTextColor(...PDF_COLORS.white);
    doc.setFontSize(18); doc.setFont('helvetica', 'bold');
    doc.text(String(a.overallScore), sx, 24, { align: 'center' });
    doc.setFontSize(7);
    doc.text('/ 100', sx, 30, { align: 'center' });

    y = 58;

    // ===== SECTION 2: EXECUTIVE SUMMARY =====
    sectionTitle('Executive Summary');

    // Score bar
    doc.setFillColor(230, 230, 230);
    doc.roundedRect(M, y, CW, 7, 2, 2, 'F');
    const fillW = (a.overallScore / 100) * CW;
    doc.setFillColor(...ratingColor(a.overallRating));
    doc.roundedRect(M, y, Math.max(fillW, 4), 7, 2, 2, 'F');
    doc.setFontSize(8); doc.setFont('helvetica', 'bold');
    doc.setTextColor(...PDF_COLORS.white);
    if (fillW > 30) doc.text(a.overallRating.toUpperCase() + ' (' + a.overallScore + '/100)', M + 4, y + 5);
    y += 12;

    // Key metrics table
    doc.autoTable({
      startY: y,
      head: [['Metric', 'Value', 'Rating']],
      body: [
        ['Play Rate', fmtPct(a.metrics.playRate.value), a.metrics.playRate.rating.toUpperCase()],
        ['Engagement', fmtPct(a.metrics.engagement.value), a.metrics.engagement.rating.toUpperCase()],
        ['Conversion Rate', fmtPct(a.metrics.conversionRate.value), a.metrics.conversionRate.rating.toUpperCase()],
        ['Unmute Rate', fmtPct(a.metrics.unmuteRate.value), a.metrics.unmuteRate.rating.toUpperCase()],
      ],
      theme: 'grid',
      styles: { fontSize: 10, cellPadding: 4, lineColor: PDF_COLORS.tableBorder },
      headStyles: { fillColor: PDF_COLORS.tableHeader, textColor: PDF_COLORS.white, fontStyle: 'bold' },
      didParseCell: function(data) {
        if (data.column.index === 2 && data.section === 'body') {
          const r = data.cell.raw.toLowerCase();
          data.cell.styles.textColor = ratingColor(r);
          data.cell.styles.fontStyle = 'bold';
        }
      },
      margin: { left: M, right: M },
    });
    y = doc.lastAutoTable.finalY + 10;

    // ===== SECTION 3: DETAILED PERFORMANCE METRICS =====
    sectionTitle('Detailed Performance Metrics');

    const metricsBody = [
      ['Total Impressions', (stats.impressions || 0).toLocaleString()],
      ['Total Plays', (stats.plays || 0).toLocaleString()],
      ['Unique Plays', (stats.playsUnique || 0).toLocaleString()],
      ['Play Rate', fmtPct(stats.playRate)],
      ['Unique Play Rate', fmtPct(stats.uniquePlayRate)],
      ['Engagement', fmtPct(stats.engagement)],
      ['Unmute Rate', fmtPct(stats.unmuteRate)],
      ['Unmute Count', (stats.unmuteCount || 0).toLocaleString()],
      ['Conversions', (stats.conversionCount || 0).toLocaleString()],
      ['Conversion Rate', fmtPct(stats.conversionRate)],
      ['Revenue', '$' + (stats.revenue || 0).toFixed(2)],
      ['Revenue per Viewer', '$' + (stats.revenuePerViewer || 0).toFixed(2)],
      ['Avg Revenue per Conversion', '$' + (stats.revenueAverage || 0).toFixed(2)],
    ];
    doc.autoTable({
      startY: y,
      head: [['Metric', 'Value']],
      body: metricsBody,
      theme: 'striped',
      styles: { fontSize: 10, cellPadding: 4, lineColor: PDF_COLORS.tableBorder },
      headStyles: { fillColor: PDF_COLORS.tableHeader, textColor: PDF_COLORS.white, fontStyle: 'bold' },
      alternateRowStyles: { fillColor: PDF_COLORS.bgLight },
      margin: { left: M, right: M },
    });
    y = doc.lastAutoTable.finalY + 10;

    // ===== SECTION 4: VIEWER RETENTION =====
    if (a.significantDrops && a.significantDrops.length > 0) {
      sectionTitle('Significant Drop-off Points');
      doc.setFontSize(9); doc.setFont('helvetica', 'normal');
      doc.setTextColor(...PDF_COLORS.textLight);
      doc.text('Points where viewers leave the video at above-normal rates', M, y);
      y += 6;

      doc.autoTable({
        startY: y,
        head: [['Time', 'Viewers Before', 'Viewers After', 'Drop %', 'Severity']],
        body: a.significantDrops.map(d => [
          d.formattedTime,
          d.viewersBefore.toLocaleString(),
          d.viewersAfter.toLocaleString(),
          '-' + (d.dropPercentage || 0).toFixed(1) + '%',
          d.severity.toUpperCase(),
        ]),
        theme: 'grid',
        styles: { fontSize: 9, cellPadding: 4, lineColor: PDF_COLORS.tableBorder },
        headStyles: { fillColor: PDF_COLORS.tableHeader, textColor: PDF_COLORS.white, fontStyle: 'bold' },
        didParseCell: function(data) {
          if (data.column.index === 3 && data.section === 'body') {
            data.cell.styles.textColor = PDF_COLORS.critical;
            data.cell.styles.fontStyle = 'bold';
          }
          if (data.column.index === 4 && data.section === 'body') {
            data.cell.styles.textColor = ratingColor(data.cell.raw.toLowerCase());
            data.cell.styles.fontStyle = 'bold';
          }
        },
        margin: { left: M, right: M },
      });
      y = doc.lastAutoTable.finalY + 10;
    }

    // ===== SECTION 5: RECOMMENDATIONS =====
    if (a.recommendations && a.recommendations.length > 0) {
      sectionTitle('Recommendations');

      const groups = { critical: [], warning: [], suggestion: [], positive: [] };
      a.recommendations.forEach(r => { if (groups[r.type]) groups[r.type].push(r); });

      const typeLabels = { critical: 'Critical Issues', warning: 'Warnings', suggestion: 'Suggestions', positive: 'Strengths' };
      const typeColors = { critical: PDF_COLORS.critical, warning: PDF_COLORS.poor, suggestion: PDF_COLORS.primary, positive: PDF_COLORS.excellent };

      for (const [type, recs] of Object.entries(groups)) {
        if (recs.length === 0) continue;
        needPage(15);

        // Type label with colored bar
        doc.setFillColor(...typeColors[type]);
        doc.rect(M, y, 3, 6, 'F');
        doc.setTextColor(...PDF_COLORS.dark);
        doc.setFontSize(12); doc.setFont('helvetica', 'bold');
        doc.text(typeLabels[type], M + 6, y + 5);
        y += 10;

        recs.forEach(r => {
          needPage(25);
          doc.setFontSize(10); doc.setFont('helvetica', 'bold');
          doc.setTextColor(...PDF_COLORS.dark);
          doc.text(r.title, M + 4, y); y += 5;

          doc.setFontSize(9); doc.setFont('helvetica', 'normal');
          doc.setTextColor(...PDF_COLORS.text);
          const dl = doc.splitTextToSize(r.detail, CW - 8);
          needPage(dl.length * 4 + 2);
          doc.text(dl, M + 4, y); y += dl.length * 4 + 2;

          doc.setTextColor(...PDF_COLORS.primary);
          doc.setFont('helvetica', 'italic');
          const al = doc.splitTextToSize('Action: ' + r.actionableStep, CW - 8);
          needPage(al.length * 4 + 2);
          doc.text(al, M + 4, y); y += al.length * 4 + 6;
        });
      }
      y += 5;
    }

    // ===== AI SECTIONS (6-9) ‚Äî only if AI analysis was run =====
    if (ai) {

      // ===== SECTION 6: EXPERT ANALYSIS =====
      doc.addPage(); y = M;

      // Purple header bar
      doc.setFillColor(...PDF_COLORS.secondary);
      doc.rect(0, 0, PW, 14, 'F');
      doc.setTextColor(...PDF_COLORS.white);
      doc.setFontSize(16); doc.setFont('helvetica', 'bold');
      doc.text('Expert Analysis', M, 10);
      y = 20;

      // Overall Verdict
      if (ai.overallVerdict) {
        subTitle('Overall Verdict');
        bodyText(ai.overallVerdict);
        y += 4;
      }

      // Each expert
      ai.expertFeedback.forEach((expert, i) => {
        needPage(50);

        // Expert header bar
        doc.setFillColor(...PDF_COLORS.secondary);
        doc.roundedRect(M, y, CW, 9, 2, 2, 'F');
        doc.setTextColor(...PDF_COLORS.white);
        doc.setFontSize(11); doc.setFont('helvetica', 'bold');
        doc.text(expert.expertName + '  ‚Äî  ' + expert.expertRole, M + 4, y + 6.5);
        y += 13;

        // Assessment
        bodyText(expert.overallAssessment, 2);
        y += 2;

        // Strengths & Weaknesses table
        const maxLen = Math.max(expert.strengths.length, expert.weaknesses.length);
        if (maxLen > 0) {
          const rows = [];
          for (let j = 0; j < maxLen; j++) {
            rows.push([
              expert.strengths[j] ? '+ ' + expert.strengths[j] : '',
              expert.weaknesses[j] ? '- ' + expert.weaknesses[j] : '',
            ]);
          }
          doc.autoTable({
            startY: y,
            head: [['Strengths', 'Weaknesses']],
            body: rows,
            theme: 'grid',
            styles: { fontSize: 9, cellPadding: 3, lineColor: PDF_COLORS.tableBorder, overflow: 'linebreak' },
            headStyles: { fillColor: PDF_COLORS.tableHeader, textColor: PDF_COLORS.white },
            columnStyles: {
              0: { textColor: PDF_COLORS.excellent },
              1: { textColor: PDF_COLORS.critical },
            },
            margin: { left: M, right: M },
          });
          y = doc.lastAutoTable.finalY + 4;
        }

        // Priority Action box
        needPage(16);
        doc.setFillColor(245, 243, 255);
        doc.roundedRect(M, y, CW, 14, 2, 2, 'F');
        doc.setDrawColor(...PDF_COLORS.secondary);
        doc.setLineWidth(0.3);
        doc.roundedRect(M, y, CW, 14, 2, 2, 'S');
        doc.setTextColor(...PDF_COLORS.secondary);
        doc.setFontSize(9); doc.setFont('helvetica', 'bold');
        doc.text('#1 Priority Action:', M + 3, y + 5);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(...PDF_COLORS.dark);
        const prioLines = doc.splitTextToSize(expert.priorityAction, CW - 8);
        doc.text(prioLines, M + 3, y + 10);
        y += 14 + (prioLines.length > 1 ? (prioLines.length - 1) * 4 : 0) + 4;

        // Specific Fixes
        if (expert.specificFixes && expert.specificFixes.length > 0) {
          needPage(20);
          doc.autoTable({
            startY: y,
            head: [['Timestamp', 'Issue', 'Recommended Fix']],
            body: expert.specificFixes.map(f => [f.timestamp, f.issue, f.fix]),
            theme: 'grid',
            styles: { fontSize: 8, cellPadding: 3, lineColor: PDF_COLORS.tableBorder, overflow: 'linebreak' },
            headStyles: { fillColor: PDF_COLORS.tableHeader, textColor: PDF_COLORS.white },
            columnStyles: {
              0: { cellWidth: 22, fontStyle: 'bold', textColor: PDF_COLORS.secondary },
              1: { textColor: [180, 60, 60] },
              2: { textColor: [30, 120, 70] },
            },
            margin: { left: M, right: M },
          });
          y = doc.lastAutoTable.finalY + 6;
        }

        y += 6;
      });

      // ===== SECTION 7: CRO TEST OPPORTUNITIES =====
      const allTests = [];
      ai.expertFeedback.forEach((expert, i) => {
        if (expert.croTests) {
          expert.croTests.forEach(t => allTests.push({ ...t, source: expert.expertName }));
        }
        const key = 'expert' + i;
        if (generatedCROBatches[key]) {
          generatedCROBatches[key].forEach(batch => {
            batch.tests.forEach(t => allTests.push({ ...t, source: expert.expertName + ' (Generated)' }));
          });
        }
      });

      if (allTests.length > 0) {
        doc.addPage(); y = M;

        doc.setFillColor(...PDF_COLORS.emerald);
        doc.rect(0, 0, PW, 14, 'F');
        doc.setTextColor(...PDF_COLORS.white);
        doc.setFontSize(16); doc.setFont('helvetica', 'bold');
        doc.text('CRO Test Opportunities (' + allTests.length + ' tests)', M, 10);
        y = 20;

        doc.autoTable({
          startY: y,
          head: [['Test Name', 'Hypothesis', 'Control vs. Variant', 'Expected Impact', 'Source']],
          body: allTests.map(t => [
            t.testName,
            t.hypothesis,
            'Control: ' + t.control + '\nVariant: ' + t.variant,
            t.expectedImpact,
            t.source,
          ]),
          theme: 'grid',
          styles: { fontSize: 8, cellPadding: 3, lineColor: PDF_COLORS.tableBorder, overflow: 'linebreak' },
          headStyles: { fillColor: PDF_COLORS.emerald, textColor: PDF_COLORS.white, fontStyle: 'bold' },
          columnStyles: {
            0: { cellWidth: 28, fontStyle: 'bold' },
            2: { cellWidth: 45 },
            4: { cellWidth: 24, textColor: PDF_COLORS.secondary, fontStyle: 'italic' },
          },
          margin: { left: M, right: M },
        });
        y = doc.lastAutoTable.finalY + 10;
      }

      // ===== SECTION 8: DROP-OFF CONTENT ANALYSIS =====
      if (ai.timestampAnalysis && ai.timestampAnalysis.length > 0) {
        doc.addPage(); y = M;
        sectionTitle('Drop-off Content Analysis');
        doc.setFontSize(9); doc.setFont('helvetica', 'normal');
        doc.setTextColor(...PDF_COLORS.textLight);
        doc.text('What is happening in the video at each major drop-off point', M, y);
        y += 6;

        doc.autoTable({
          startY: y,
          head: [['Time', 'On Screen', 'Audio', 'Issue', 'Fix']],
          body: ai.timestampAnalysis.map(ts => [
            ts.formattedTime || ts.timestamp,
            ts.contentDescription,
            ts.audioDescription,
            ts.issue,
            ts.fix,
          ]),
          theme: 'grid',
          styles: { fontSize: 8, cellPadding: 3, lineColor: PDF_COLORS.tableBorder, overflow: 'linebreak' },
          headStyles: { fillColor: PDF_COLORS.tableHeader, textColor: PDF_COLORS.white, fontStyle: 'bold' },
          columnStyles: {
            0: { cellWidth: 16, fontStyle: 'bold', textColor: PDF_COLORS.secondary },
            3: { textColor: [180, 60, 60] },
            4: { textColor: [30, 120, 70] },
          },
          margin: { left: M, right: M },
        });
        y = doc.lastAutoTable.finalY + 10;
      }

      // ===== SECTION 9: SCRIPT STRUCTURE =====
      if (ai.scriptStructure) {
        needPage(40);
        sectionTitle('Script Structure Analysis');

        const ss = ai.scriptStructure;
        const sections = [
          ['Hook', ss.hook],
          ['Problem', ss.problem],
          ['Solution', ss.solution],
          ['Proof', ss.proof],
          ['CTA', ss.cta],
        ].filter(([, text]) => text);

        if (sections.length > 0) {
          doc.autoTable({
            startY: y,
            head: [['Section', 'Analysis']],
            body: sections,
            theme: 'grid',
            styles: { fontSize: 9, cellPadding: 4, lineColor: PDF_COLORS.tableBorder, overflow: 'linebreak' },
            headStyles: { fillColor: PDF_COLORS.secondary, textColor: PDF_COLORS.white, fontStyle: 'bold' },
            columnStyles: {
              0: { cellWidth: 25, fontStyle: 'bold', textColor: PDF_COLORS.secondary },
            },
            margin: { left: M, right: M },
          });
          y = doc.lastAutoTable.finalY + 6;
        }

        if (ss.overallFlow) {
          needPage(20);
          subTitle('Overall Flow');
          bodyText(ss.overallFlow, 2);
        }
      }

    } // end AI sections

    // ===== PAGE NUMBERS & FOOTER =====
    const totalPages = doc.internal.getNumberOfPages();
    for (let p = 1; p <= totalPages; p++) {
      doc.setPage(p);
      doc.setFontSize(8); doc.setFont('helvetica', 'normal');
      doc.setTextColor(...PDF_COLORS.textLight);
      doc.text('Vidalytics Analytics Report', M, PH - 8);
      doc.text('Page ' + p + ' of ' + totalPages, PW - M, PH - 8, { align: 'right' });
    }

    // ===== SAVE =====
    const filename = 'Video_Report_' + sanitizeFn(a.videoName) + '_' + new Date().toISOString().split('T')[0] + '.pdf';
    doc.save(filename);

  } catch (e) {
    console.error('PDF generation error:', e);
    alert('Error generating report: ' + e.message);
  } finally {
    if (btn) { btn.disabled = false; btn.textContent = 'Download Client Report'; }
  }
}

// ‚îÄ‚îÄ Utilities ‚îÄ‚îÄ
function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
function show(id) { document.getElementById(id).classList.remove('hidden'); }
function hide(id) { document.getElementById(id).classList.add('hidden'); }
</script>
</body>
</html>
